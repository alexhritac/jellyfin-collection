# =============================================================================
# JELLYFIN COLLECTION - Docker Compose pour Portainer
# =============================================================================
# Utiliser avec Portainer Stacks + GitHub integration
# Image: ghcr.io/4lx69/jellyfin-collection:latest
#
# Variables à configurer dans Portainer:
# - JELLYFIN_URL, JELLYFIN_API_KEY
# - TMDB_API_KEY
# - RADARR_URL, RADARR_API_KEY (optionnel)
# - SONARR_URL, SONARR_API_KEY (optionnel)
# - DISCORD_WEBHOOK_URL (optionnel)
# - OPENAI_API_KEY, OPENAI_ENABLED (optionnel)
# =============================================================================

services:
  jellyfin-collection:
    image: ghcr.io/4lx69/jellyfin-collection:latest
    container_name: jellyfin-collection
    restart: unless-stopped

    environment:
      # =========================================================================
      # JELLYFIN (requis)
      # =========================================================================
      - JELLYFIN_URL=${JELLYFIN_URL:?JELLYFIN_URL is required}
      - JELLYFIN_API_KEY=${JELLYFIN_API_KEY:?JELLYFIN_API_KEY is required}

      # =========================================================================
      # TMDB (requis)
      # =========================================================================
      - TMDB_API_KEY=${TMDB_API_KEY:?TMDB_API_KEY is required}
      - TMDB_LANGUAGE=${TMDB_LANGUAGE:-fr}
      - TMDB_REGION=${TMDB_REGION:-FR}

      # =========================================================================
      # TRAKT (optionnel)
      # =========================================================================
      - TRAKT_CLIENT_ID=${TRAKT_CLIENT_ID:-}
      - TRAKT_CLIENT_SECRET=${TRAKT_CLIENT_SECRET:-}
      - TRAKT_ACCESS_TOKEN=${TRAKT_ACCESS_TOKEN:-}

      # =========================================================================
      # RADARR (optionnel - ajout films manquants)
      # =========================================================================
      - RADARR_URL=${RADARR_URL:-}
      - RADARR_API_KEY=${RADARR_API_KEY:-}
      - RADARR_ROOT_FOLDER=${RADARR_ROOT_FOLDER:-/movies}
      - RADARR_QUALITY_PROFILE=${RADARR_QUALITY_PROFILE:-HD-1080p}
      - RADARR_DEFAULT_TAG=${RADARR_DEFAULT_TAG:-jfc}

      # =========================================================================
      # SONARR (optionnel - ajout séries manquantes)
      # =========================================================================
      - SONARR_URL=${SONARR_URL:-}
      - SONARR_API_KEY=${SONARR_API_KEY:-}
      - SONARR_ROOT_FOLDER=${SONARR_ROOT_FOLDER:-/tv}
      - SONARR_QUALITY_PROFILE=${SONARR_QUALITY_PROFILE:-HD-1080p}
      - SONARR_DEFAULT_TAG=${SONARR_DEFAULT_TAG:-jfc}

      # =========================================================================
      # DISCORD (optionnel - notifications)
      # =========================================================================
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
      - DISCORD_WEBHOOK_CHANGES=${DISCORD_WEBHOOK_CHANGES:-}

      # =========================================================================
      # OPENAI (optionnel - génération de posters IA)
      # =========================================================================
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_ENABLED=${OPENAI_ENABLED:-false}
      - OPENAI_POSTER_HISTORY_LIMIT=${OPENAI_POSTER_HISTORY_LIMIT:-5}

      # =========================================================================
      # SCHEDULER
      # =========================================================================
      # Sync collections: tous les jours à 3h
      - SCHEDULER_COLLECTIONS_CRON=${SCHEDULER_COLLECTIONS_CRON:-0 3 * * *}
      # Régénération posters: 1er du mois à 4h (vide = désactivé)
      - SCHEDULER_POSTERS_CRON=${SCHEDULER_POSTERS_CRON:-0 4 1 * *}
      # Sync au démarrage
      - SCHEDULER_RUN_ON_START=${SCHEDULER_RUN_ON_START:-true}
      - SCHEDULER_TIMEZONE=${SCHEDULER_TIMEZONE:-Europe/Paris}

      # =========================================================================
      # APPLICATION
      # =========================================================================
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CONFIG_PATH=/config
      - DATA_PATH=/data
      - LOG_PATH=/logs
      - DRY_RUN=${DRY_RUN:-false}

    volumes:
      # Configurations Kometa (YAML) - lecture seule
      - ${CONFIG_PATH:-./config}:/config:ro
      # Données persistantes (cache, posters, reports)
      - jfc-data:/data
      # Logs
      - jfc-logs:/logs

    # Réseau (adapter selon votre configuration)
    networks:
      - default

volumes:
  jfc-data:
    name: jellyfin-collection-data
  jfc-logs:
    name: jellyfin-collection-logs
